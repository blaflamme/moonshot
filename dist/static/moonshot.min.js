/*

 Declare the module with dependencies, and nothing more.

 */

var appModules = [
  'ngAnimate', 'ngMessages', 'ui.router', 'restangular', 'satellizer'
];

if (document.URL.indexOf(':9000') != -1) {
  appModules.push('ngMockE2E');
  appModules.push('moonshotMock');
}
angular.module('moonshot', appModules)
  .value('mockRest', {});


/*

 When running in dev mode, mock calls to the REST API
 but pass everything else through.

 */

(function (ng, mod, _, undefined) {
  'use strict';

  mod.run(function ($httpBackend, moonshotMockRest) {

    var mocks = moonshotMockRest.getMocks();

    // Iterate over all the registered mocks and register them
    _.map(mocks, function (moduleMocks) {
      // All the mocks registered for this module
      _(moduleMocks).forEach(function (mock) {
        var method = mock[0];
        var match = mock[1],
          responder = mock[2];
        $httpBackend.when(
          method,
          match)
          .respond(responder);
      });
    });

    // pass through everything else
    $httpBackend.whenGET(/\/*/).passThrough();
    $httpBackend.whenPOST(/\/*/).passThrough();
    $httpBackend.whenPUT(/\/*/).passThrough();

  });

}(angular, angular.module('moonshotMock', ['moonshot', 'ngMockE2E']), _));

(function () {

  function MoonshotMocks() {
    this.mocks = {};

    this.$get = function () {
      var mocks = this.mocks;
      return {
        getMocks: function () {
          return mocks;
        }
      };
    };

    this.addMock = function (k, v) {
      this.mocks[k] = v;
    };
  }

  function ModuleInit() {
    /* Empty for now */
  }

  angular.module("moonshot")
    .provider('moonshotMockRest', MoonshotMocks)
    .config(ModuleInit);


})();

(function () {

  function AuthzRedirect($q, $injector) {

    return {
      responseError: function (rejection) {
        var $state = $injector.get('$state');
        if (rejection.status == 403 || rejection.status == 401) {
          // Redirect to the login form
          $state.go('siteroot.login');
        }
        return $q.reject(rejection);
      }
    };

  }

  function ModuleInit($httpProvider, $authProvider, $injector) {

    $httpProvider.interceptors.push('authzRedirect');
    $authProvider.twitter({
                            url: 'http://127.0.0.1:3000/auth/twitter'
                          });
  }

  angular.module("moonshot")
    .factory('authzRedirect', AuthzRedirect)
    .config(ModuleInit);

})();


(function () {

  function LoginCtrl($auth) {
    this.authenticate = function (provider) {
      $auth.authenticate(provider);
    };
  }

  function ProfileCtrl($http, $log, $auth) {
    var _this = this;
    this.user = {};

    $http.get('/api/me')
      .success(function (response) {
                 $log.debug('server profile data:', response);
                 _this.user = response.user;
               });
  }

  function HeaderCtrl($log, $rootScope, $state, $auth) {
    var ctrl = this;
    this.$rootScope = $rootScope;
    this.$state = $state;
    this.$auth = $auth;

    this.logout = function () {
      $auth.logout()
        .then(function () {
                $state.go('siteroot.login');
              });
    };

    this.sections = _($state.get())
      .filter(function (state) {
                return _.has(state, "section");
              })
      .map(function (state) {
             var s = state.section;
             return {
               title: s.title,
               priority: s.priority ? s.priority : 99,
               state: state.name
             };
           })
      .sortBy("priority")
      .value();


    this.isAuthenticated = function() {
      $log.debug("isAuthenticated:", $auth.isAuthenticated());
      return $auth.isAuthenticated();
    };


    // When the state changes, update the subsections
    this.subsections = this.$state.current.subsections;
    $rootScope.$on('$stateChangeSuccess', ctrl.updateSubsections);
    $rootScope.$on('$stateChangeSuccess', function (event, toState) {
      $rootScope.$evalAsync(function () {
        // Wrap in $evalAsync as we are re-assigning a list
        ctrl.subsections = toState.subsections;
      });
    });
  }

  angular.module("moonshot")
    .controller("HeaderCtrl", HeaderCtrl)
    .controller("LoginCtrl", LoginCtrl)
    .controller('ProfileCtrl', ProfileCtrl);

})();

(function () {

  function RestLogger($q, $log) {

    return {
      request: function (config) {
        var isApi = config.url.substring(0, 5) == '/api/';
        if (1==1) {
          $log.info('request url/method/data',
                    config.url, config.method, config.data);
        }
        return config || $q.when(config);
      },
      response: function (response) {
        var config = response.config;
        var isApi = config.url.substring(0, 5) == '/api/';
        if (1==1) {
          $log.info('response url/method/data',
                    config.url, config.method, response.data);
        }
        return response || $q.when(response);
      }
    };
  }


  function ModuleInit($httpProvider) {

    $httpProvider.interceptors.push('restLogger');
  }

  angular.module("moonshot")
    .factory('restLogger', RestLogger)
    .config(ModuleInit);

})
();


(function () {

  function ModuleInit($stateProvider, $urlRouterProvider, RestangularProvider) {

    RestangularProvider.setBaseUrl('http://127.0.0.1:3000/api');

    $stateProvider
      .state('siteroot', {
               abstract: true,
               url: "",
               views: {
                 "header": {
                   templateUrl: '/app/header.partial.html',
                   controller: "HeaderCtrl as HeaderCtrl"
                 },
                 "content": {
                   template: '<div ui-view="content"></div>'
                 }
               }
             })
      .state('siteroot.login', {
               url: '/login',
               views: {
                 'content': {
                   templateUrl: '/app/login.partial.html',
                   controller: 'LoginCtrl as LoginCtrl'
                 }
               }
             })
      .state('siteroot.profile', {
               url: '/profile',
               views: {
                 'content': {
                   templateUrl: '/app/profile.partial.html',
                   controller: 'ProfileCtrl as ProfileCtrl'
                 }
               }
             });

    $urlRouterProvider.rule(function ($injector, $location) {

      // Handle the case of going to index.html without #/
      if ($location.url() === "") {
        return "/";
      }

    });

  }

  angular.module("moonshot")
    .config(ModuleInit);
})();

(function () {

    function FoldersHomeCtrl($log) {
  }

  angular.module("moonshot")
    .controller("FoldersHomeCtrl", FoldersHomeCtrl);


})();

(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'folder-home'}
    ];

    $stateProvider
      .state("folder-home", {
               url: "/folder",
               parent: "siteroot",
               section: {
                 title: "Folders",
                 priority: 2
               },
               subsections: subsections,
               views: {
                 "content": {
                   templateUrl: "/folder/folder-home.partial.html"
                 }
               }
             });
  }

  angular.module("moonshot")
    .config(ModuleInit);

})();



(function () {

    function SiteFormCtrl($log) {
  }

  angular.module("moonshot")
    .controller("SiteFormCtrl", SiteFormCtrl);


})();

(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'siteroot.site'},
      {label: 'Form', state: 'siteroot.site.form'}
    ];

    $stateProvider
      .state("siteroot.site", {
               url: "/",
               section: {
                 title: "Home",
                 priority: 1
               },
               subsections: subsections,
               views: {
                 "content": {
                   templateUrl: "/site/home.partial.html"
                 }
               }
             })
      .state("siteroot.site.form", {
               url: "form",
               views: {
                 "content@siteroot": {
                   templateUrl: "/site/form.partial.html",
                   controller: "SiteFormCtrl as SiteFormCtrl"
                 }
               }
             });
  }

  angular.module("moonshot")
    .config(ModuleInit);

})();



(function () {

  function UsersHomeCtrl(users) {
    this.users = users;
  }

  angular.module('moonshot')
    .controller('UsersHomeCtrl', UsersHomeCtrl);
})();

(function () {

  function ModuleInit(moonshotMockRestProvider) {

    var usersData = [
      {
        'id': 'i1',
        'title': 'Milk'
      }
    ];
    moonshotMockRestProvider.addMock(
      'users',
      [
        [
          'GET',
          /api\/users$/,
          function () {
            return [200, usersData];
          }]
      ]);

    moonshotMockRestProvider.addMock(
      'authenticate',
      [
        [
          'POST',
          /api\/authenticate/,
          function (method, url, data) {
            data = angular.fromJson(data);
            var un = data.username;
            var pw = data.password;
            var response;

            if (un === 'paul') {
              response = [204, {}];
            } else {
              response = [401, {"message": "Invalid login or password"}];
            }

            return response;
          }]
      ]);
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



(function () {

  function ModuleInit($stateProvider) {

    var subsections = [
      {label: 'Home', state: 'users'}
    ];

    $stateProvider
      .state('users', {
               url: '/users/',
               parent: 'siteroot',
               section: {
                 title: 'Users',
                 priority: 1
               },
               subsections: subsections,
               views: {
                 content: {
                   templateUrl: '/user/users-home.partial.html',
                   controller: 'UsersHomeCtrl as UsersHomeCtrl'
                 }
               },
               resolve: {
                 users: function (Restangular) {
                   return Restangular.all('users').getList();
                 }
               }
             });
  }

  angular.module('moonshot')
    .config(ModuleInit);

})();



//# sourceMappingURL=moonshot.min.js.map